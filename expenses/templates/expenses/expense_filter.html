{% extends 'expenses/base.html' %}
{% block content %}
<h2>Filter Expenses</h2>
<form method="get" class="row g-3 mb-4">
  <div class="col-md-3">
    <select name="filter_type" class="form-select" required>
      <option value="">Select Filter Type</option>
      <option value="date" {% if filter_type == 'date' %}selected{% endif %}>Date</option>
      <option value="month" {% if filter_type == 'month' %}selected{% endif %}>Month</option>
      <option value="year" {% if filter_type == 'year' %}selected{% endif %}>Year</option>
    </select>
  </div>
  <div class="col-md-3">
    <select name="category" class="form-select">
      <option value="">All Categories</option>
      {% for cat in categories %}
        {% if cat %}
          <option value="{{ cat }}" {% if category == cat %}selected{% endif %}>{{ cat }}</option>
        {% endif %}
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <input id="filter-value" type="text" name="filter_value" class="form-control" placeholder="e.g. 2025-08-18 or 2025-08 or 2025" value="{{ filter_value|default:'' }}" required>
  </div>
  <div class="col-md-2 d-flex gap-2">
    <button type="submit" class="btn btn-primary">Filter</button>
    <a href="{% url 'expense_list' %}" class="btn btn-info">Home</a>
  </div>
</form>
{% if expenses %}
  <h4>Total Expense:
    {% if total and total > 0 %}
      <span class="badge bg-success">₹ {{ total }}</span>
    {% else %}
      <span class="badge bg-success">Total Expenses (All Time): ₹ {{ all_time_total|default:0 }}</span>
    {% endif %}
  </h4>
  <ul class="list-group mt-3">
    {% for expense in expenses %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>{{ expense.date }} | {{ expense.category }} | {{ expense.title }}</span>
        <span class="badge bg-primary">₹ {{ expense.amount }}</span>
      </li>
    {% endfor %}
  <hr>
  <h5>Category-wise Total</h5>
  <ul class="list-group mb-3">
    {% for cat, cat_total in category_totals.items %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>{{ cat }}</span>
        <span class="badge bg-info">₹ {{ cat_total }}</span>
      </li>
    {% endfor %}
  </ul>
  </ul>
{% else %}
  <div class="alert alert-info">No expenses found for this filter.</div>
{% endif %}
<script>
  function updateInputType() {
    var filterType = document.querySelector('select[name="filter_type"]').value;
    var input = document.getElementById('filter-value');
    if (filterType === 'date') {
      input.type = 'date';
      input.placeholder = 'Select date';
    } else if (filterType === 'month') {
      input.type = 'month';
      input.placeholder = 'Select month';
    } else if (filterType === 'year') {
      input.type = 'number';
      input.placeholder = 'Enter year';
      input.min = '1900';
      input.max = '2100';
    } else {
      input.type = 'text';
      input.placeholder = 'e.g. 2025-08-18 or 2025-08 or 2025';
    }
  }
  document.addEventListener('DOMContentLoaded', function() {
    updateInputType();
    document.querySelector('select[name="filter_type"]').addEventListener('change', updateInputType);
  });
</script>
{% endblock %}
